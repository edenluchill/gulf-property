# 📸 图片存储升级 - Cloudflare R2

## 问题

之前的图片存储方式：
- ❌ 存储在本地服务器 `/uploads/langgraph-output/`
- ❌ 难以读取，不够快
- ❌ 无法扩展（单服务器限制）
- ❌ 部署困难（需要持久化存储）

## 解决方案

升级到 **Cloudflare R2**：
- ✅ 云端存储，无限空间
- ✅ 全球CDN加速，访问飞快
- ✅ 可扩展到任意规模
- ✅ 成本低廉（$0.015/GB/月，无流量费）

## 工作流程

### 1. PDF处理时
```
上传PDF → AI提取图片 → 自动上传到 R2 临时文件夹
                        ↓
                   temp/{jobId}/images/
                        ↓
                   返回公开URL给前端显示
```

### 2. 用户提交时
```
用户点击"提交项目" → 自动转移图片到永久文件夹
                      ↓
                 projects/{projectId}/images/
                      ↓
                 永久保存，随时可用
```

### 3. 自动清理
```
定时脚本（每天运行）→ 删除24小时以上的临时文件
                     ↓
                 节省存储空间和成本
```

## 配置步骤

### 1️⃣ 创建 Cloudflare R2 Bucket

1. 登录 [Cloudflare Dashboard](https://dash.cloudflare.com/)
2. 进入 **R2** 菜单
3. 点击 **"Create bucket"**
4. 名称：`gulf-property-images`
5. 位置：选择离用户最近的（如 APAC）

### 2️⃣ 获取 API 凭证

1. R2 页面点击 **"Manage R2 API Tokens"**
2. 点击 **"Create API Token"**
3. 权限：**Read & Write**
4. 复制：
   - Access Key ID
   - Secret Access Key
   - 你的 Account ID（在URL或右侧栏）

### 3️⃣ 配置域名（推荐）

1. 在 Bucket 设置中添加自定义域名
2. 如：`images.yourdomain.com`
3. 添加 DNS 记录（CNAME）

### 4️⃣ 更新 `.env` 配置

在 `backend/.env` 中添加：

```env
# Cloudflare R2 配置
R2_ENDPOINT=https://<你的account-id>.r2.cloudflarestorage.com
R2_ACCESS_KEY_ID=<你的access-key-id>
R2_SECRET_ACCESS_KEY=<你的secret-access-key>
R2_BUCKET_NAME=gulf-property-images
R2_PUBLIC_URL=https://images.yourdomain.com
```

**示例：**
```env
R2_ENDPOINT=https://abc123def456.r2.cloudflarestorage.com
R2_ACCESS_KEY_ID=1234567890abcdef
R2_SECRET_ACCESS_KEY=abcdef1234567890
R2_BUCKET_NAME=gulf-property-images
R2_PUBLIC_URL=https://images.gulfproperty.ae
```

### 5️⃣ 测试连接

```bash
cd backend
npm run cleanup-r2
```

看到 `✅ R2 connection successful` 就成功了！

## 使用方法

### 正常使用（自动）

配置好后，系统自动处理：
- ✅ PDF处理时 → 自动上传图片到R2
- ✅ 前端显示 → 自动从R2加载
- ✅ 项目提交 → 自动转移到永久位置

### 定期清理临时文件

```bash
# 手动运行清理
npm run cleanup-r2

# 或用PowerShell
./cleanup-r2-temp-files.ps1
```

### 设置自动清理

**Linux/Ubuntu (Cron):**
```bash
crontab -e
# 添加：每天凌晨2点清理
0 2 * * * cd /path/to/backend && npm run cleanup-r2
```

**Windows (任务计划程序):**
1. 打开"任务计划程序"
2. 创建基本任务
3. 触发器：每天 02:00
4. 操作：运行 `cleanup-r2-temp-files.ps1`

## 成本估算

### Cloudflare R2 定价

- **存储**：$0.015/GB/月
- **写入**：$4.50/百万次
- **读取**：$0.36/百万次
- **流量**：**完全免费** 🎉

### 实际成本（100个项目）

- 存储 1GB = **$0.015**
- 上传 1,000次 = **$0.004**
- 浏览 100,000次 = **$0.036**
- **总计：~$0.055/月**

对比 AWS S3：相同用量约 $10-20/月

## 文件说明

### 新增文件

1. **`src/services/r2-storage.ts`**
   - R2存储服务核心代码
   - 上传、转移、删除图片
   - 连接测试

2. **`cleanup-r2-temp-files.ts`**
   - 清理脚本（TypeScript）
   - 删除24小时以上临时文件

3. **`cleanup-r2-temp-files.ps1`**
   - 清理脚本（PowerShell）
   - 方便Windows用户运行

4. **`CLOUDFLARE_R2_SETUP.md`**
   - 详细英文配置指南
   - 故障排查

5. **`R2_MIGRATION_SUMMARY.md`**
   - 技术变更总结
   - 迁移流程说明

### 修改文件

1. **`src/langgraph/processors/simple-image-extractor.ts`**
   - 改为上传到R2而不是本地

2. **`src/routes/residential-projects.ts`**
   - 提交时转移图片到永久位置

3. **`env.template`**
   - 添加R2配置项

4. **`package.json`**
   - 添加 `npm run cleanup-r2` 命令

## 常见问题

### Q: 不配置R2可以运行吗？
A: 可以！会自动回退到本地存储（旧方式）

### Q: 旧的本地图片怎么办？
A: 会继续正常工作，新上传的用R2

### Q: 图片显示不出来？
A: 检查：
1. R2_PUBLIC_URL 是否正确
2. Bucket 是否允许公开访问
3. CORS 设置是否正确
4. 浏览器控制台有无错误

### Q: 需要迁移旧图片吗？
A: 不必要，旧图片会继续工作。新项目自动用R2

### Q: 成本会很高吗？
A: 非常便宜！100个项目约$0.055/月，比本地服务器省钱

## 监控

在 Cloudflare R2 Dashboard 查看：
- 存储使用量
- 请求次数
- 实际成本

## 详细文档

- 📖 **英文配置指南**：`CLOUDFLARE_R2_SETUP.md`
- 📖 **技术变更总结**：`R2_MIGRATION_SUMMARY.md`
- 📖 **官方文档**：[Cloudflare R2 Docs](https://developers.cloudflare.com/r2/)

## 完成 ✅

配置好 `.env` 后就可以用了！上传PDF测试一下吧 🚀
